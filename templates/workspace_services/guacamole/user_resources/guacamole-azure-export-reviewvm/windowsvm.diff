diff -Naur ../guacamole-azure-windowsvm/terraform/data.tf terraform/data.tf
--- ../guacamole-azure-windowsvm/terraform/data.tf	2022-09-23 15:04:16.000000000 +0100
+++ terraform/data.tf	2022-10-11 23:05:59.000000000 +0100
@@ -17,6 +17,12 @@
   resource_group_name  = data.azurerm_resource_group.ws.name
 }
 
+data "azurerm_subnet" "webapps" {
+  name                 = "WebAppsSubnet"
+  virtual_network_name = data.azurerm_virtual_network.ws.name
+  resource_group_name  = data.azurerm_resource_group.ws.name
+}
+
 data "azurerm_key_vault" "ws" {
   name                = local.keyvault_name
   resource_group_name = data.azurerm_resource_group.ws.name
@@ -26,3 +32,8 @@
   name                = "guacamole-${var.tre_id}-ws-${local.short_workspace_id}-svc-${local.short_parent_id}"
   resource_group_name = data.azurerm_resource_group.ws.name
 }
+
+data "azurerm_private_endpoint_connection" "airlock_export_inprogress_pe" {
+  name                = "pe-sa-ip-export-blob-${local.short_workspace_id}"
+  resource_group_name = data.azurerm_resource_group.ws.name
+}
diff -Naur ../guacamole-azure-windowsvm/terraform/variables.tf terraform/variables.tf
--- ../guacamole-azure-windowsvm/terraform/variables.tf	2022-10-10 09:55:40.000000000 +0100
+++ terraform/variables.tf	2022-10-11 23:07:15.000000000 +0100
@@ -11,3 +11,4 @@
 variable "image_gallery_id" {
   default = ""
 }
+variable "airlock_request_sas_url" {}
diff -Naur ../guacamole-azure-windowsvm/terraform/windowsvm.tf terraform/windowsvm.tf
--- ../guacamole-azure-windowsvm/terraform/windowsvm.tf	2022-10-10 09:55:40.000000000 +0100
+++ terraform/windowsvm.tf	2022-10-11 23:10:15.000000000 +0100
@@ -11,6 +11,83 @@
   }
 }
 
+resource "azurerm_network_security_group" "vm_nsg" {
+  name                = "vm-nsg-${local.service_resource_name_suffix}"
+  location            = data.azurerm_resource_group.ws.location
+  resource_group_name = data.azurerm_resource_group.ws.name
+  tags                = local.tre_user_resources_tags
+}
+
+resource "azurerm_network_security_rule" "allow_outbound_airlock_exip_storage_pe" {
+  access                        = "Allow"
+  # Should this be a list?
+  destination_address_prefixes  = [for pe in data.azurerm_private_endpoint_connection.airlock_export_inprogress_pe.private_service_connection: pe.private_ip_address]
+  destination_port_range        = "*"
+  direction                     = "Outbound"
+  name                          = "allow-airlock-exip-storage-pe"
+  network_security_group_name   = azurerm_network_security_group.vm_nsg.name
+  priority                      = 101
+  protocol                      = "*"
+  resource_group_name           = data.azurerm_resource_group.ws.name
+  source_address_prefixes       = azurerm_windows_virtual_machine.windowsvm.private_ip_addresses
+  source_port_range             = "*"
+}
+
+// Outbound traffic gets routed to the firewall
+resource "azurerm_network_security_rule" "allow_outbound_to_internet" {
+  access                      = "Allow"
+  destination_address_prefix  = "INTERNET"
+  destination_port_range      = "443"
+  direction                   = "Outbound"
+  name                        = "to-internet"
+  network_security_group_name = azurerm_network_security_group.vm_nsg.name
+  priority                    = 120
+  protocol                    = "Tcp"
+  resource_group_name         = data.azurerm_resource_group.ws.name
+  source_address_prefixes     = azurerm_windows_virtual_machine.windowsvm.private_ip_addresses
+  source_port_range           = "*"
+}
+
+resource "azurerm_network_security_rule" "allow_outbound_webapps_to_vm" {
+  access = "Allow"
+  destination_port_ranges = [
+    "80",
+    "443",
+    "445",
+    "3306",
+    "3389",
+    "5432",
+  ]
+  destination_address_prefixes = azurerm_windows_virtual_machine.windowsvm.private_ip_addresses
+  source_address_prefixes      = data.azurerm_subnet.webapps.address_prefixes
+  direction                    = "Outbound"
+  name                         = "outbound-from-webapps-to-vm"
+  network_security_group_name  = azurerm_network_security_group.vm_nsg.name
+  priority                     = 140
+  protocol                     = "Tcp"
+  resource_group_name          = data.azurerm_resource_group.ws.name
+  source_port_range            = "*"
+}
+
+resource "azurerm_network_security_rule" "deny_outbound_override" {
+  access                      = "Deny"
+  destination_address_prefix  = "*"
+  destination_port_range      = "*"
+  direction                   = "Outbound"
+  name                        = "deny-outbound-override"
+  network_security_group_name = azurerm_network_security_group.vm_nsg.name
+  priority                    = 4096
+  protocol                    = "*"
+  resource_group_name         = data.azurerm_resource_group.ws.name
+  source_address_prefixes     = azurerm_windows_virtual_machine.windowsvm.private_ip_addresses
+  source_port_range           = "*"
+}
+
+resource "azurerm_network_interface_security_group_association" "nsg_association" {
+  network_interface_id = azurerm_network_interface.internal.id
+  network_security_group_id = azurerm_network_security_group.vm_nsg.id
+}
+
 resource "random_string" "username" {
   length      = 4
   upper       = true
@@ -44,7 +121,7 @@
   admin_username             = random_string.username.result
   admin_password             = random_password.password.result
 
-  custom_data = base64encode(data.template_file.vm_config.rendered)
+  custom_data = base64encode(data.template_file.download_review_data_script.rendered)
 
   # set source_image_id/reference depending on the config for the selected image
   source_image_id = local.selected_image_source_id
@@ -93,15 +170,12 @@
   tags         = local.tre_user_resources_tags
 }
 
-data "template_file" "vm_config" {
-  template = file("${path.module}/vm_config.ps1")
+data "template_file" "download_review_data_script" {
+  template = file("${path.module}/download_review_data.ps1")
   vars = {
-    nexus_proxy_url     = local.nexus_proxy_url
-    SharedStorageAccess = var.shared_storage_access ? 1 : 0
-    StorageAccountName  = data.azurerm_storage_account.stg.name
-    StorageAccountKey   = data.azurerm_storage_account.stg.primary_access_key
-    FileShareName       = var.shared_storage_access ? data.azurerm_storage_share.shared_storage[0].name : ""
-    CondaConfig         = local.selected_image.conda_config ? 1 : 0
+    airlock_request_sas_url = var.airlock_request_sas_url
+    username                = random_string.username.result
+    hostname                = local.vm_name
   }
 }
 
@@ -115,3 +189,4 @@
   name                 = var.shared_storage_name
   storage_account_name = data.azurerm_storage_account.stg.name
 }
+
