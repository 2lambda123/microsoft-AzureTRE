---
#cloud-config
package_upgrade: true
package_update: true
apt:
  sources:
    docker.list:
      source: deb [arch=amd64]
        https://download.docker.com/linux/ubuntu $RELEASE stable
      keyid: 9DC858229FC7DD38854AE2D88D81803C0EBFCD88
      keyserver: hkp://keyserver.ubuntu.com:80

packages:
  - docker-ce
  - docker-ce-cli
  - containerd.io
  - docker-compose
  - gnupg2
  - pass

# create the docker group
groups:
  - docker

# Add default auto created user to docker group
system_info:
  default_user:
    groups: [docker]

write_files:
  # a weekly cron job to have docker free disk space
  - path: /etc/cron.weekly/docker-prune
    content: |
      #!/bin/bash
      set -o errexit
      docker system prune -f
    permissions: '0755'
  # ensure Nexus doesn't create default repositories
  - path: /etc/nexus-data/nexus.properties
    content: |
      nexus.skipDefaultRepositories=true
    permissions: '0755'

runcmd:
  - export DEBIAN_FRONTEND=noninteractive
  # Give the Nexus process write permissions on the folder mounted as persistent volume
  - chown -R 200 /etc/nexus-data
  # Run the nexus container (exposing port 8081 and mapping volume for nexus config)
  - docker run -d
    -p 8081:8081
    -v /etc/nexus-data:/nexus-data
    --restart always
    --name nexus
    --log-driver local
    sonatype/nexus3
  # Set our own admin password so we can connect to the Nexus repository manager later on
  - CURRENT_PASSWORD=$(cat /etc/nexus-data/admin.password)
  - curl -ifu admin:${CURRENT_PASSWORD} -XPUT -H 'Content-Type: text/plain' --data "${nexus_admin_password}" \
      http://localhost:8081/service/rest/v1/security/users/admin/change-password
