name: AzureTRE Continuous Delivery

on:
  push:
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: Dev
    env:
      TF_VAR_environment: "dev"
      TF_VAR_address_space: "10.0.0.0/16"
      TF_VAR_state_storage: "stgmsfttretfstate"
      TF_VAR_mgmt_res_group: "rg-msft-tre-tfstate"
      TF_VAR_state_container: "tfstate"
      TF_VAR_resource_name_prefix: "msfttre"
      TF_VAR_location: "westeurope"
      TF_VAR_image_tag: "v1"

    steps:
    - uses: actions/checkout@v2

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Install Terraform
      uses: little-core-labs/install-terraform@v2.0.0
      with:
          version: 0.13.4

    - name: Make .env files
      shell: bash
      run: |
          env_file="devops/terraform/.env"
          cat <<EOF > $env_file
          TF_VAR_state_storage=${{ env.TF_VAR_state_storage }}
          TF_VAR_mgmt_res_group=${{ env.TF_VAR_mgmt_res_group }}
          TF_VAR_state_container=${{ env.TF_VAR_state_container }}
          TF_VAR_location=${{ env.TF_VAR_location }}
          TF_VAR_resource_name_prefix=${{ env.TF_VAR_resource_name_prefix }}
          TF_VAR_image_tag=${{ env.TF_VAR_image_tag }}
          EOF

          env_file="templates/core/terraform/.env"
          cat <<EOF > $env_file
          TF_VAR_environment=${{ env.TF_VAR_environment }}
          TF_VAR_address_space=${{ env.TF_VAR_address_space }}
          EOF

    - name: Make bootstrap for terraform
      shell: bash
      env:
        AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      run: |
          export ARM_CLIENT_ID=$(echo "$AZURE_CREDENTIALS" | jq -r '.clientId')
          export ARM_CLIENT_SECRET=$(echo "$AZURE_CREDENTIALS" | jq -r '.clientSecret')
          export ARM_SUBSCRIPTION_ID=$(echo "$AZURE_CREDENTIALS" | jq -r '.subscriptionId')
          export ARM_TENANT_ID=$(echo "$AZURE_CREDENTIALS" | jq -r '.tenantId')

          make bootstrap
